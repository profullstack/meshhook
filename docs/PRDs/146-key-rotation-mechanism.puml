@startuml
!theme plain

title Key Rotation Mechanism Workflow

actor Admin as admin
boundary "CLI/API" as cli
control "Key Rotation Service" as krs
database "Supabase Postgres" as db
entity "EncryptionKeys Table" as ekt
control "Secrets Encryption Service" as ses
control "Audit Log Service" as als

== Key Rotation Trigger ==
admin -> cli : Trigger Rotation\n(Manual or Scheduled)
cli -> krs : Initiate Key Rotation

== Key Generation ==
krs -> db : Request current active key
db --> krs : Return active key details
krs -> krs : Generate new encryption key

== Secrets Re-encryption ==
krs -> ses : Start re-encryption with new key
ses -> db : Fetch secrets encrypted with old key
db --> ses : Return secrets
ses -> ses : Re-encrypt secrets with new key
ses -> db : Update secrets with new encryption

== Key Versioning ==
krs -> db : Deactivate old key
krs -> ekt : Insert new key as active
ekt -> db : Update EncryptionKeys Table

== Audit Logging ==
krs -> als : Log key rotation activity
als -> db : Store log in audit table

== Completion ==
krs --> cli : Key Rotation Complete
cli --> admin : Notify completion

@enduml