@startuml
!theme plain

title Signature Verification (HMAC) Process

actor "Webhook Source" as source
boundary "SvelteKit SSR/API" as sveltekit
database "Supabase Postgres" as supabase
entity "HMAC Secrets" as secrets
control "Middleware" as middleware
control "Webhook Handler" as handler

source -> sveltekit : Webhook Request\n(with Signature)
sveltekit -> middleware : Intercept Request
middleware -> supabase : Fetch HMAC Secret\n(project-specific)
supabase -> middleware : Return Secret
middleware -> middleware : Verify Signature\n(using HMAC-SHA256)
alt Signature Valid
    middleware -> handler : Proceed with Processing
    handler -> supabase : Trigger Workflow Execution
else Signature Invalid
    middleware -> source : HTTP 401 Unauthorized
end

note right of handler
  - Workflows are initiated\n  based on the webhook's payload.
  - Only webhooks with verified\n  signatures trigger workflows.
end note

note over supabase
  Stores project-specific\n  HMAC secrets securely.
end note

note over middleware
  Responsible for signature\n  verification logic.
end note

@enduml